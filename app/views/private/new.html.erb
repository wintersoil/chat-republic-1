<div class="experimental-messages" data-attr="<%= current_user.id %>"></div>

<div class="private-messages-container">
<% @private_messages.each do |msg| %>
 <%= render "private/message", msg: msg %>
<% end %>
</div>

<%= form_for @private_message, url: {action:"create", controller:"private"}, remote: true do |f| %>
  <div class="private-message-rounded-send">
    <%= f.text_field :body, autocomplete: :off, class:'private-message-input' %>
    <%= f.hidden_field :recipient, :value => @recipient.to_i %>
    <%= image_submit_tag("https://aliphotoappimages.s3.ca-central-1.amazonaws.com/svg/private_message_send.svg", height:'50', width:'50', class:'private-message-send') %>
  </div>
<% end %>
<%= image_tag("https://aliphotoappimages.s3.ca-central-1.amazonaws.com/svg/microphone.svg", id:"private_record", height:'90px', width:'90px', data: {attr: @recipient.to_i}) %>
<%= image_tag("https://aliphotoappimages.s3.ca-central-1.amazonaws.com/svg/video.svg", id:"private_recordVideo", height:'90px', width:'90px', data: {attr: @recipient.to_i}) %>
<img src="https://aliphotoappimages.s3.ca-central-1.amazonaws.com/svg/microphone_off.svg" height="0px" width="0px" />
<img src="https://aliphotoappimages.s3.ca-central-1.amazonaws.com/svg/videoOff.svg" height="0px" width="0px" />
<%= link_to private_chat_path(id: @recipient.to_i), method: :delete do %>
  <%= image_tag("https://aliphotoappimages.s3.ca-central-1.amazonaws.com/svg/private_message_empty.svg", height:'90', width:'90', class:'private-message-empty') %>
<% end %>
<%= image_tag("https://aliphotoappimages.s3.ca-central-1.amazonaws.com/svg/private_message_empty_hover.svg", height:'0', width:'0') %>

<%= audio_tag("definite.mp3", autoplay: false, controls: true, style: "display:none", id:"hollow-copy") %>
<%= audio_tag("definite_iphone.m4r", autoplay: false, controls: true, style: "display:none", id:"hollow-copy-1") %>
<%= image_tag("https://aliphotoappimages.s3.ca-central-1.amazonaws.com/svg/private_message_send.svg", height:'0', width:'0') %>
<%= image_tag("https://aliphotoappimages.s3.ca-central-1.amazonaws.com/svg/private_message_send_hover.svg", height:'0', width:'0') %>
<script>
try{
  navigator.mediaDevices.getUserMedia({audio:true}).then(stream => {private_handlerFunction(stream)});
}
catch(err){
  try{
    navigator.mediaDevices.webkitGetUserMedia({audio:true}).then(stream => {private_handlerFunction(stream)});
  }
  catch(err){
    try{
    navigator.mediaDevices.mozGetUserMedia({audio:true}).then(stream => {private_handlerFunction(stream)});
    }
    catch(err){
      console.log("If all media requests fails,   Error:   " + err);
    }
  }
}
let private_recording = false;
$("#private_record").click(function(e){
  if(private_recording == false)
  {
    audioChunks = [];
    window.private_rec.start();
    private_recording = true;
    var hover = "https://aliphotoappimages.s3.ca-central-1.amazonaws.com/svg/microphone_off.svg";
    $("#private_record").attr( "src", hover );
    $("#private_record").attr( "height", "90px" );
    $("#private_record").attr( "width", "90px");
  }
  else {
    private_recording = false;
    var hover = "https://aliphotoappimages.s3.ca-central-1.amazonaws.com/svg/microphone.svg";
    $("#private_record").attr( "src", hover );
    $("#private_record").attr( "height", "90px" );
    $("#private_record").attr( "width", "90px");
    window.private_rec.stop();
  }
});

function private_handlerFunction(stream) {
  window.private_rec = new MediaRecorder(stream);
  window.private_rec.ondataavailable = e => {
    audioChunks.push(e.data);
    let url1;
    if(private_rec.state == "inactive"){
      let blob = new Blob(audioChunks,{type:"audio/mpeg"});
      try{
       url1 = webkitURL.createObjectURL(blob);
    }
    catch(err)
    {
      url1 = URL.createObjectURL(blob);
    }
      var reader = new FileReader();
      reader.onload = function(event){
        var fd = {};
        fd["recipient"] = $('#private_record').attr('data-attr');
        fd["fname"] = "test.mp3";
        fd["data"] = event.target.result;
        $.ajax({
          type: "POST",
          url: "/privateUploadMP3",
          data: fd,
          dataType: "text"
        }).done(function(data){
        });
      };
      reader.readAsDataURL(blob);
    }
  }
}




//video streaming
try{
  navigator.mediaDevices.getUserMedia({video:true,audio:true}).then(stream => {private_handlerFunctionVideo(stream)});
}
catch(err){
  try{
  navigator.mediaDevices.webkitGetUserMedia({video:true,audio:true}).then(stream => {private_handlerFunctionVideo(stream)});
  }
  catch(err){
    try{
    navigator.mediaDevices.mozGetUserMedia({video:true,audio:true}).then(stream => {private_handlerFunctionVideo(stream)});
    }
    catch(err)
    {
      console.log("If all media requests fails,    Error:   " + err);
    }
  }
}
let private_recordingVideo = false;
$("#private_recordVideo").click(function(e){
  if(private_recordingVideo == false)
  {
    audioChunks = [];
    window.private_recVideo.start();
    private_recordingVideo = true;
    var hover = "https://aliphotoappimages.s3.ca-central-1.amazonaws.com/svg/videoOff.svg";
    $("#private_recordVideo").attr( "src", hover );
    $("#private_recordVideo").attr( "height", "90px" );
    $("#private_recordVideo").attr( "width", "90px");
  }
  else {
    private_recordingVideo = false;
    var hover = "https://aliphotoappimages.s3.ca-central-1.amazonaws.com/svg/video.svg";
    $("#private_recordVideo").attr( "src", hover );
    $("#private_recordVideo").attr( "height", "90px" );
    $("#private_recordVideo").attr( "width", "90px");
    window.private_recVideo.stop();
  }
});

function private_handlerFunctionVideo(stream) {
  window.private_recVideo = new MediaRecorder(stream);
  window.private_recVideo.ondataavailable = e => {
    audioChunks.push(e.data);
    let url1;
    if(private_recVideo.state == "inactive"){
      let blob = new Blob(audioChunks,{type:"video/mp4"});
      try{
       url1 = webkitURL.createObjectURL(blob);
    }
    catch(err)
    {
      url1 = URL.createObjectURL(blob);
    }
      var reader = new FileReader();
      reader.onload = function(event){
        var fd = {};
        fd["recipient"] = $('#private_recordVideo').attr('data-attr');
        fd["fname"] = "test.mp4";
        fd["data"] = event.target.result;
        $.ajax({
          type: "POST",
          url: "/privateUploadMP4",
          data: fd,
          dataType: "text"
        }).done(function(data){
        });
      };
      reader.readAsDataURL(blob);
    }
  }
}
</script>
