<div>
  I am on video page now!
  <%= link_to "Destroy connection", video_path(id: @client.id), method: :delete %>
</div>
<video autoplay></video>
<img id="returned-photo" src="">

<script>
const video = document.querySelector('video');
navigator.mediaDevices.getUserMedia({video: {width: 426, height: 240}}).then((stream) => video.srcObject = stream);

const getFrame = () => {
  const canvas = document.createElement('canvas');
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  canvas.getContext('2d').drawImage(video, 0, 0);
  const data = canvas.toDataURL('image/png');
  return data;
}

const WS_URL = 'wss://demoapplication1-env.hw7neqyjpm.ca-central-1.elasticbeanstalk.com/cable';
const FPS = 3;
const ws = new WebSocket(WS_URL);
id = { channel: current_user.user_name }
ws.onopen = () => {
  console.log('Connected to ${WS_URL}');
  setInterval(() => {
    ws.send(JSON.parse({command: 'message', identifier: id, data: {action:'handle_messages',id:current_user.id,client: '<%= @client.id %>',image:getFrame()}}));
  }, 1000 / FPS);
}
</script>
<script>
const img = document.getElementById("returned-photo");
const WS_URL2 = 'wss://demoapplication1-env.hw7neqyjpm.ca-central-1.elasticbeanstalk.com/cable';
const ws2 = new WebSocket(WS_URL2);
ws2.onopen = () => console.log('Connected to ${WS_URL2}');
ws2.onmessage = message => {
  img.src = message.image;
}
</script>
